name: Deploy to Snowflake with Rollback Support
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - rollback
      rollbackCount:
        description: 'Number of changesets to rollback'
        required: false
        default: '1'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Display Repository Structure
        run: |
          echo "Repository contents:"
          find . -type f | grep -v "/.git/" | sort
      
      - name: Create Proper XML Master Changelog
        run: |
          # Make sure the directory exists
          mkdir -p dbscripts
          
          # Create a proper XML changelog file
          cat > dbscripts/master.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog
              xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
              
              <include file="change1.sql" relativeToChangelogFile="true"/>
              <include file="change2.sql" relativeToChangelogFile="true"/>
          </databaseChangeLog>
          EOF
          
          # Verify the file was created
          echo "Master changelog created:"
          cat dbscripts/master.xml
      
      - name: Download and Extract Liquibase
        run: |
          mkdir -p liquibase
          cd liquibase
          wget -q https://github.com/liquibase/liquibase/releases/download/v4.25.0/liquibase-4.25.0.tar.gz
          tar -xzf liquibase-4.25.0.tar.gz
          chmod +x liquibase
      
      - name: Download Snowflake JDBC Driver
        run: |
          cd liquibase
          mkdir -p lib
          wget -q https://repo1.maven.org/maven2/net/snowflake/snowflake-jdbc/3.14.5/snowflake-jdbc-3.14.5.jar -O lib/snowflake-jdbc-3.14.5.jar
          echo "JDBC driver downloaded:"
          ls -la lib/
      
      - name: Run Liquibase Action
        env:
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          # Verify everything is in place
          echo "Repository structure:"
          find $GITHUB_WORKSPACE -type f | grep -v "/.git/" | sort
          
          cd $GITHUB_WORKSPACE/liquibase
          
          # Use absolute path for changelog file and include search path
          ./liquibase \
            --classpath=./lib/snowflake-jdbc-3.14.5.jar \
            --driver=net.snowflake.client.jdbc.SnowflakeDriver \
            --url="jdbc:snowflake://WXVXDID-ZN02370.snowflakecomputing.com/?db=${{ secrets.SNOWFLAKE_DATABASE }}&schema=${{ secrets.SNOWFLAKE_SCHEMA }}&warehouse=COMPUTE_WH" \
            --username=${{ secrets.SNOWFLAKE_USER }} \
            --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
            --changelog-file=$GITHUB_WORKSPACE/dbscripts/master.xml \
            --search-path=$GITHUB_WORKSPACE/dbscripts \
            validate
          
          # Determine action
          if [[ "${{ github.event.inputs.action }}" == "rollback" ]]; then
            echo "Performing rollback of ${{ github.event.inputs.rollbackCount }} changesets"
            ./liquibase \
              --classpath=./lib/snowflake-jdbc-3.14.5.jar \
              --driver=net.snowflake.client.jdbc.SnowflakeDriver \
              --url="jdbc:snowflake://WXVXDID-ZN02370.snowflakecomputing.com/?db=${{ secrets.SNOWFLAKE_DATABASE }}&schema=${{ secrets.SNOWFLAKE_SCHEMA }}&warehouse=COMPUTE_WH" \
              --username=${{ secrets.SNOWFLAKE_USER }} \
              --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
              --changelog-file=$GITHUB_WORKSPACE/dbscripts/master.xml \
              --search-path=$GITHUB_WORKSPACE/dbscripts \
              rollbackCount ${{ github.event.inputs.rollbackCount }} --logLevel=debug
          else
            echo "Performing update"
            ./liquibase \
              --classpath=./lib/snowflake-jdbc-3.14.5.jar \
              --driver=net.snowflake.client.jdbc.SnowflakeDriver \
              --url="jdbc:snowflake://WXVXDID-ZN02370.snowflakecomputing.com/?db=${{ secrets.SNOWFLAKE_DATABASE }}&schema=${{ secrets.SNOWFLAKE_SCHEMA }}&warehouse=COMPUTE_WH" \
              --username=${{ secrets.SNOWFLAKE_USER }} \
              --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
              --changelog-file=$GITHUB_WORKSPACE/dbscripts/master.xml \
              --search-path=$GITHUB_WORKSPACE/dbscripts \
              update --logLevel=debug
          fi
